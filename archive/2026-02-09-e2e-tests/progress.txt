# Ralph Progress Log
Started: Sun Feb  9 11:40:00 MST 2026
---

## Codebase Patterns
- E2E tests use embedded-postgres on port 15432, database `slurpee_test`
- `TestMain` must call `flag.Parse()` before `testing.Short()` in Go 1.25+
- Migration parser extracts lines between `-- +migrate Up` and `-- +migrate Down` markers
- `truncateAll` uses single TRUNCATE with CASCADE for all tables (faster than individual truncates)
- Seed helpers use `bcrypt.MinCost` for fast test execution (not default cost 10)
- For delivery pipeline tests: use `httptest.NewServer` (not `httptest.ResponseRecorder`) since the dispatcher makes real HTTP calls
- Poll DB for `delivery_status` changes via `waitForEventStatus` helper — never use `time.Sleep` for delivery assertions
- `app.StartDispatcher(slurpee)` starts delivery goroutines; dispatcher goroutines leak in tests but are acceptable since each test creates its own app
- `stopDelivery` is unexported — for tests, don't try to call it; just poll DB state and let goroutines leak
- `newTestApp` wires real `db.Queries` to embedded postgres, not mocks
- `seedApiSecret` returns both the db record and the plaintext for use in auth headers
- POST /events sends to `DeliveryChan` — call `drainDeliveryChan(slurpee)` after each create test to avoid blocking
- API routes are prefixed with `/api/` — use `/api/events`, `/api/subscribers`, etc. in test requests
- When all subscriptions match by subject but none pass filter, `dispatchEvent` marks event as `failed` (not `delivered`) — "No valid subscribers found" path
- Filter matching is AND logic on top-level JSON keys — `matchesFilter` in `app/delivery.go` compares JSON-marshaled values for type-safe equality
- `MaxRetries=2` in config means total attempts = 3 (initial + 2 retries) — `attemptNum >= maxRetries` is the exhaustion check
- `MaxBackoffSeconds=1` caps exponential backoff at 1 second, keeping retry tests fast
- `atomic.Int32` is cleaner than `sync.Mutex` + `int` for simple request counting in mock endpoints
- `dispatchEvent` cannot be reused for partial events — it starts fresh with attemptNum=0 for all subscribers
- `inflightWg`, `taskQueue`, and `registry` are local to `StartDispatcher` — resume logic needs access to these

