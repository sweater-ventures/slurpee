# Ralph Progress Log
Started: Thu Feb  5 19:29:35 MST 2026

## Codebase Patterns
- Use `IF NOT EXISTS` for all CREATE TABLE and CREATE INDEX statements in migrations
- sql-migrate uses `-- +migrate Up` and `-- +migrate Down` comment markers
- Source .env before running sql-migrate: `set -a && source .env && set +a && sql-migrate up`
- sqlc config at sqlc.yaml uses pgx/v5 driver with custom type overrides for timestamptz and nullable text
- Build with `go build ./...` to verify no compilation errors
- Use `sqlc.arg(name)` for named parameters in sqlc queries to get clean Go struct field names
- JSONB containment search: `WHERE data @> $1` with `@>` operator
- Go 1.22+ method routing: use `"POST /events"` pattern in ServeMux for method-restricted routes
- API routes register under `/events` (not `/api/events`) — the `/api` prefix is stripped by AddApis()
- Use `pgtype.UUID{Valid: false}` for nullable UUID columns (SQL NULL); `json.RawMessage` for JSONB round-tripping
- Path parameters: `"GET /events/{id}"` route pattern + `r.PathValue("id")` to extract
- Async delivery: `deliverEvent(app, event)` in api/delivery.go triggers background goroutine; uses `context.Background()` not request context
- SimplePage requires two params: `SimplePage(title, currentPath)` — currentPath enables active sidebar highlighting
- Templ generate: `go tool templ generate -f <file>` for specific files; `go build ./...` after to verify
- HTMX partial rendering: extract content into a separate templ component, use hx-target/hx-swap to replace just that section
- DaisyUI modal: `<dialog class="modal">` with `.showModal()`/`.close()`, `<form method="dialog">` for cancel button
- Templ `script` keyword for type-safe JS functions callable from `onclick={ funcName(args) }`
- HTMX edit pattern: use `hx-put` for updates, `hx-delete` for deletes, `hx-post` for creates; all target a shared content div
- EventBus: in-memory pub/sub in app/eventbus.go; Subscribe() returns (<-chan BusMessage, unsubscribe func); Publish() does non-blocking fan-out with monotonic IDs
- EventBus publishing: all event creation paths publish BusMessageCreated; updateEventStatus publishes BusMessageStatusChanged; deliverToSubscriber/recordFailedAttempt publish BusMessageDeliveryAttempt
- Package shadowing workaround: when `app` parameter shadows `app` package, use package-level helpers with `a` parameter name
---

## 2026-02-05 19:30 MST - US-001
- Implemented EventBus struct in app/eventbus.go with Subscribe/Publish methods and monotonically increasing message IDs (atomic.Uint64)
- BusMessage struct includes: ID, Type (created|status_changed|delivery_attempt), EventID, Subject, DeliveryStatus, Timestamp, and optional delivery attempt fields
- Subscriber channels have buffer capacity of 64; Publish drops messages for slow consumers (non-blocking send)
- Added EventBus field to Application struct and initialize in NewApp
- Files changed: app/eventbus.go (new), app/application.go (modified)
- **Learnings for future iterations:**
  - EventBus uses sync.RWMutex: RLock for Publish (concurrent reads), full Lock for Subscribe/Unsubscribe
  - atomic.Uint64 for thread-safe monotonic ID generation without locking
  - Non-blocking send pattern: `select { case ch <- msg: default: }` drops for slow consumers
  - When function parameter name shadows a package import (e.g. `func handler(app *app.Application)`), create a package-level helper function to access the package types
---

## 2026-02-05 19:37 MST - US-002
- Published EventBus messages from all event creation and delivery pipeline code paths
- `eventCreateSubmitHandler` in views/events.go: publishes 'created' message via helper `publishCreatedEvent`
- `createEventHandler` in api/events.go: publishes 'created' message via helper `publishCreatedEvent`
- `updateEventStatus` in api/delivery.go: publishes 'status_changed' message after updating DB
- `deliverToSubscriber` in api/delivery.go: publishes 'delivery_attempt' message after recording attempt (includes endpoint, status, response code)
- `recordFailedAttempt` in api/delivery.go: publishes 'delivery_attempt' message for pre-response failures
- Files changed: views/events.go, api/events.go, api/delivery.go
- **Learnings for future iterations:**
  - Parameter name `app` shadows the `app` package import in handler functions — use a package-level helper function to construct types from the shadowed package
  - Helper pattern: `publishCreatedEvent(a *app.Application, event db.Event)` can be called from shadowed scope since it uses `a` not `app` as parameter name
  - All bus publish calls should happen after the DB operation succeeds (not before) to ensure consistency
  - `recordFailedAttempt` also needs a bus publish for delivery_attempt — don't forget error path publishing
---
