# Ralph Progress Log
Started: Wed Feb  4 15:46:59 MST 2026

## Codebase Patterns
- Use `IF NOT EXISTS` for all CREATE TABLE and CREATE INDEX statements in migrations
- sql-migrate uses `-- +migrate Up` and `-- +migrate Down` comment markers
- Source .env before running sql-migrate: `set -a && source .env && set +a && sql-migrate up`
- dbconfig.yml uses `host=${DB_HOST} dbname=${DB_NAME} user=${DB_ADMIN_USERNAME} password=${DB_ADMIN_PASSWORD} sslmode=disable` format
- DB admin credentials are in .env as DB_ADMIN_USERNAME/DB_ADMIN_PASSWORD; app credentials as DB_USERNAME/DB_PASSWORD
- sqlc config at sqlc.yaml uses pgx/v5 driver with custom type overrides for timestamptz and nullable text
- Build with `go build ./...` to verify no compilation errors
- Makefile `db/models.go` target runs `go tool sqlc generate` when query or schema files change
- Use `sqlc.arg(name)` for named parameters in sqlc queries to get clean Go struct field names
- JSONB containment search: `WHERE data @> $1` with `@>` operator
- PostgreSQL TEXT[] maps to Go `[]string` in sqlc without needing a custom override
- Go 1.22+ method routing: use `"POST /events"` pattern in ServeMux for method-restricted routes
- API routes register under `/events` (not `/api/events`) — the `/api` prefix is stripped by AddApis()
- Use `pgtype.UUID{Valid: false}` for nullable UUID columns (SQL NULL); `json.RawMessage` for JSONB round-tripping

---

## 2026-02-04 15:48 MST - US-001
- Created events table migration: schema/20260204154757-create-events-table.sql
- Table has 8 columns: id (UUID PK), subject, timestamp, trace_id, data (JSONB), retry_count, delivery_status, status_updated_at
- Three indexes: subject, timestamp, delivery_status
- Migration applies cleanly via sql-migrate up
- Files changed: schema/20260204154757-create-events-table.sql
- **Learnings for future iterations:**
  - The database was already provisioned via Docker with slurpee_admin and slurpee roles
  - gorp_migrations table tracks applied migrations (used by sql-migrate)
  - Previous session work wasn't on a persisted branch, so had to recreate from scratch
  - Always verify migration status with `sql-migrate status` after applying
---

## 2026-02-04 15:56 MST - US-002
- Created subscribers table migration: schema/20260204155540-create-subscribers-table.sql
- Table has 7 columns: id (UUID PK), name, endpoint_url (unique), auth_secret, max_parallel (default 1), created_at (default now), updated_at (default now)
- Unique constraint on endpoint_url enforced via UNIQUE keyword in column definition
- Migration applies cleanly, build passes
- Files changed: schema/20260204155540-create-subscribers-table.sql
- **Learnings for future iterations:**
  - UNIQUE keyword on column definition creates both a unique constraint and implicit unique index (no separate CREATE INDEX needed)
  - Following the same migration pattern as US-001 (IF NOT EXISTS, consistent formatting) works well
---

## 2026-02-04 16:01 MST - US-003
- Created subscriptions table migration: schema/20260204160051-create-subscriptions-table.sql
- Table has 7 columns: id (UUID PK), subscriber_id (UUID FK to subscribers with CASCADE DELETE), subject_pattern, filter (JSONB nullable), max_retries (integer nullable), created_at (default now), updated_at (default now)
- Index on subject_pattern for delivery routing lookups
- Foreign key constraint ensures subscriptions are deleted when parent subscriber is removed
- Migration applies cleanly, build passes
- Files changed: schema/20260204160051-create-subscriptions-table.sql
- **Learnings for future iterations:**
  - Foreign key with CASCADE DELETE syntax: `REFERENCES table(column) ON DELETE CASCADE` inline with column definition
  - Nullable columns simply omit NOT NULL (no special syntax needed for JSONB or INTEGER nullable fields)
  - The subscriptions table links subscribers to subject patterns — this is the many-to-many relationship that will be used for delivery routing
---

## 2026-02-04 16:03 MST - US-004
- Created delivery_attempts table migration: schema/20260204160332-create-delivery-attempts-table.sql
- Table has 10 columns: id (UUID PK), event_id (UUID FK to events), subscriber_id (UUID FK to subscribers), endpoint_url (text), attempted_at (timestamptz default now), request_headers (jsonb nullable), response_status_code (integer nullable), response_headers (jsonb nullable), response_body (text nullable), status (text not null)
- Foreign key constraints to both events and subscribers tables (no CASCADE DELETE — delivery history should be preserved)
- Three indexes: event_id, subscriber_id, status
- Migration applies cleanly, build passes
- Files changed: schema/20260204160332-create-delivery-attempts-table.sql
- **Learnings for future iterations:**
  - Foreign keys without CASCADE DELETE are the default — simply use REFERENCES table(column) without ON DELETE clause
  - delivery_attempts does NOT use CASCADE DELETE because delivery history should be preserved even if subscribers are removed (unlike subscriptions which are config data)
  - Status values will be 'succeeded', 'failed', 'pending' — enforced by application logic, not DB constraint
---

## 2026-02-04 16:15 MST - US-005
- Created log_config table migration: schema/20260204161528-create-log-config-table.sql
- Table has 3 columns: id (UUID PK), subject (text, not null, unique), log_properties (text array, not null)
- Unique constraint on subject enforced via UNIQUE keyword (creates implicit unique index, no separate CREATE INDEX needed)
- Migration applies cleanly, build passes
- Files changed: schema/20260204161528-create-log-config-table.sql
- **Learnings for future iterations:**
  - PostgreSQL TEXT[] type is used for text arrays — stores a list of JSON property paths
  - The log_config table is the simplest schema table (no foreign keys, no timestamps) since it's pure configuration
  - All five database schema tables (events, subscribers, subscriptions, delivery_attempts, log_config) are now complete
  - Next stories (US-006 through US-009) will create sqlc query files in queries/ directory
---

## 2026-02-04 16:22 MST - US-006
- Created sqlc query file: queries/events.sql with 8 query definitions
- Queries: InsertEvent, GetEventByID, ListEvents (paginated), SearchEventsBySubject, SearchEventsByDateRange, SearchEventsByDeliveryStatus, SearchEventsByDataContent (jsonb @> containment), UpdateEventDeliveryStatus
- Generated code: db/events.sql.go (307 lines) and db/models.go (59 lines with all 5 table models)
- Files changed: queries/events.sql, db/events.sql.go, db/models.go
- **Learnings for future iterations:**
  - sqlc uses `sqlc.arg(name)` syntax for named parameters — use this to get clean Go struct field names instead of auto-generated ones like `Timestamp_2`
  - JSONB containment search uses `@>` operator: `WHERE data @> $1` — caller passes a JSON byte slice to match against
  - sqlc generates a `models.go` file with Go structs for ALL tables in the schema, even those without queries yet
  - The querier.go interface is currently empty — it will be populated as more query files are added
  - `go tool sqlc generate` is the correct invocation (not just `sqlc generate`)
  - Generated files go to db/ directory as configured in sqlc.yaml
---

## 2026-02-04 16:28 MST - US-007
- Created sqlc query file: queries/subscribers.sql with 9 query definitions
- Subscriber queries: UpsertSubscriber (ON CONFLICT by endpoint_url), GetSubscriberByID, GetSubscriberByEndpointURL, ListSubscribers, DeleteSubscriber
- Subscription queries: CreateSubscription, ListSubscriptionsForSubscriber, DeleteSubscriptionsForSubscriber, GetSubscriptionsMatchingSubject
- GetSubscriptionsMatchingSubject uses SQL LIKE with replace() to convert glob patterns (* → %, ? → _) for delivery routing
- Generated code: db/subscribers.sql.go (240 lines)
- Files changed: queries/subscribers.sql, db/subscribers.sql.go
- **Learnings for future iterations:**
  - PostgreSQL ON CONFLICT DO UPDATE uses EXCLUDED.column_name to reference the values that would have been inserted
  - The upsert pattern returns the full row via RETURNING * regardless of whether it was an insert or update
  - For glob/wildcard matching in SQL, use replace() to convert * to % and ? to _ with LIKE operator
  - Only new files were created — existing db/models.go, db/db.go, db/querier.go, db/events.sql.go were unchanged by sqlc generate
  - sqlc correctly generates separate .sql.go files per query source file (events.sql.go, subscribers.sql.go)
---

## 2026-02-04 16:30 MST - US-008
- Created sqlc query file: queries/delivery_attempts.sql with 4 query definitions
- Queries: InsertDeliveryAttempt (all 10 columns), ListDeliveryAttemptsForEvent (ordered by attempted_at), ListDeliveryAttemptsForSubscriber (ordered by attempted_at), UpdateDeliveryAttemptStatus (updates status, response_status_code, response_headers, response_body)
- Generated code: db/delivery_attempts.sql.go (167 lines)
- Files changed: queries/delivery_attempts.sql, db/delivery_attempts.sql.go
- **Learnings for future iterations:**
  - The UpdateDeliveryAttemptStatus query updates response fields alongside status because in the delivery engine flow, a delivery attempt is first inserted with status 'pending' and then updated with the response data after the HTTP call completes
  - The InsertDeliveryAttempt params struct uses pgtype.Timestamptz for attempted_at (via sqlc override) and pgtype.Int4 for nullable response_status_code
  - JSONB columns (request_headers, response_headers) map to []byte in Go — caller is responsible for marshaling/unmarshaling JSON
  - Nullable text column (response_body) maps to string due to sqlc.yaml override for pg_catalog.text nullable
---

## 2026-02-04 16:34 MST - US-009
- Created sqlc query file: queries/log_config.sql with 4 query definitions
- Queries: UpsertLogConfig (ON CONFLICT by subject, updates log_properties), GetLogConfigBySubject, ListLogConfigs (ordered alphabetically by subject), DeleteLogConfigForSubject
- Generated code: db/log_config.sql.go (78 lines)
- Files changed: queries/log_config.sql, db/log_config.sql.go
- **Learnings for future iterations:**
  - PostgreSQL TEXT[] maps to Go []string in sqlc — no special override needed
  - The log_config upsert only updates log_properties on conflict (not id) since subject is the unique key used for lookups
  - All four sqlc query file stories (US-006 through US-009) are now complete, covering events, subscribers/subscriptions, delivery_attempts, and log_config
  - The sqlc query layer is fully implemented — next stories (US-010+) move to REST API endpoint implementation
---

## 2026-02-04 16:40 MST - US-010
- Implemented POST /api/events endpoint in api/events.go
- Accepts JSON body with subject (required), data (required JSON object), id (optional UUID v7), timestamp (optional, defaults to now), trace_id (optional UUID)
- Returns 201 with created event including assigned id and timestamp
- Returns 400 with error details for missing/invalid fields (subject, data, id, trace_id)
- Validates data is a JSON object (not array, string, etc.)
- Uses uuid.NewV7() from google/uuid for auto-generated event IDs
- Persists to database via app.DB.InsertEvent before responding
- Logs event subject and ID on receipt using slog via context logger
- Follows existing routeHandler/writeJsonResponse/init() pattern
- Helper functions: eventToResponse() converts db.Event to API response, uuidToString() converts pgtype.UUID to string
- Files changed: api/events.go (new)
- **Learnings for future iterations:**
  - Go 1.22+ method-based routing: `"POST /events"` pattern restricts to POST only without manual method checking
  - pgtype.UUID with Valid:false represents SQL NULL — use this for optional UUID fields like trace_id
  - json.RawMessage preserves raw JSON for request parsing and response serialization (no double-encoding)
  - The api/ package routes are stripped of `/api` prefix by AddApis(), so register as `/events` not `/api/events`
  - uuid.Must(uuid.NewV7()) generates time-ordered UUIDs for natural chronological ordering
---
