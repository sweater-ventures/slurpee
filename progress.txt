# Ralph Progress Log
Started: Fri Feb  6 21:16:06 MST 2026
---

## Codebase Patterns
- `emit_interface: true` in sqlc.yaml generates a populated `Querier` interface with all query methods
- `Application.DB` is typed as `db.Querier` (interface), not `*db.Queries` (concrete) — enables mock injection for testing
- Functions that accept a DB parameter should use `db.Querier` interface type, not `*db.Queries`
- `go build ./...` is the primary quality check; `go vet ./...` for additional static analysis
- Unexported functions (`matchesFilter`, `calculateBackoff`) require `package app` test files, not `package app_test`

---

## 2026-02-06 9:17 PM - US-001
- Added `emit_interface: true` to `sqlc.yaml` and regenerated sqlc code
- Changed `Application.DB` field type from `*db.Queries` to `db.Querier`
- Updated `ValidateSecretByID` and `CheckSubscriberScope` in `app/secrets.go` to accept `db.Querier` instead of `*db.Queries`
- Files changed: `sqlc.yaml`, `db/querier.go`, `app/application.go`, `app/secrets.go`
- **Learnings for future iterations:**
  - The only compile errors from the type change were in `app/secrets.go` where `ValidateSecretByID` and `CheckSubscriberScope` explicitly took `*db.Queries` — the `slurpee.DB.Method()` calls throughout the codebase work fine because the interface has all the same methods
  - LSP diagnostics may show stale errors after regenerating sqlc — trust `go build` over IDE diagnostics
  - `db.New()` still returns `*db.Queries` which satisfies `db.Querier`, so `NewApp()` needed no changes
---

## 2026-02-06 9:25 PM - US-002
- Added `github.com/stretchr/testify` as test dependency
- Created `testutil/mock_querier.go` — testify mock implementing all 38 methods of `db.Querier`
- Created `testutil/factories.go` — factory functions with functional options: `NewEvent`, `NewSubscriber`, `NewSubscription`, `NewApiSecret`, `NewApiSecretWithHash`, `NewTestApp`
- Created `testutil/helpers.go` — HTTP helpers: `NewJSONRequest`, `WithSecretHeaders`, `WithAdminSecret`, `AssertJSONResponse`, `AssertJSONError`
- Files changed: `go.mod`, `go.sum`, `testutil/mock_querier.go`, `testutil/factories.go`, `testutil/helpers.go`
- **Learnings for future iterations:**
  - `testutil` package is not a `_test` package — it's importable from any test file in the project
  - `NewApiSecretWithHash` creates secrets with real bcrypt hashes for testing `ValidateSecretByID`
  - `NewTestApp` sets `AdminSecret: "test-admin-secret"` and `DeliveryChan` buffer size 100 by default
  - Factory functions use functional option pattern (`type EventOpt func(*db.Event)`) for clean overrides
  - `go mod tidy` must be run after adding testify to resolve transitive deps (`objx`, `difflib`, etc.)
---

## 2026-02-06 9:30 PM - US-003
- Created `app/business_logic_test.go` with 59 table-driven tests covering all pure business logic
- `TestCheckSendScope` — 12 cases: exact match, wildcard patterns, empty patterns, edge cases
- `TestMatchLikePattern` — 22 cases: % at start/end/middle, _ wildcard, combined wildcards, empty strings
- `TestMatchesFilter` — 16 cases: nil/empty filters, matching/non-matching keys, nested JSON, numeric/boolean values, invalid JSON
- `TestCalculateBackoff` — 9 cases: exponential growth, max cap respected, small cap
- Files changed: `app/business_logic_test.go`
- **Learnings for future iterations:**
  - `matchesFilter` and `calculateBackoff` are unexported — tests must use `package app` (not `package app_test`) to access them
  - `matchesFilter` uses JSON marshal/unmarshal for type-safe comparison, so nested objects match correctly
  - `calculateBackoff` uses `math.Pow(2, attemptNum)` — attempt 0 = 1s, attempt 1 = 2s, etc.
---
