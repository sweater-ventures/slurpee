# Ralph Progress Log
Started: Fri Feb  6 14:03:50 MST 2026
---

## Codebase Patterns
- Migrations use `-- +migrate Up/Down` markers and timestamp-prefixed filenames (e.g., `20260206140000-description.sql`)
- Always use `IF NOT EXISTS` for CREATE TABLE/INDEX in migrations
- sqlc queries go in `queries/<table_name>.sql` with `-- name: FunctionName :one/:many/:exec` annotations
- Cast COALESCE/string_agg results to `::text` so sqlc generates `string` type instead of `interface{}`
- sqlc config uses pgx/v5 with emit_prepared_queries and various type overrides for timestamps/text
- Use `ON CONFLICT DO NOTHING` for idempotent join table inserts
- Foreign keys use `ON DELETE CASCADE` for join tables
- Session auth middleware exempts /login, /static/*, /version, /api/* routes
- Use `middleware.GetSessionFromContext(ctx)` to get session info in handlers
- templ templates regenerated via `templ generate` — produces *_templ.go files
- templ templates have implicit `ctx` variable — use Go helper functions in same package to access context (e.g., session scope checks)
- Scope helpers in views/scope_helpers.go: isSubscriberEditable, isSubjectInScope, isSessionAdmin

## 2026-02-06 14:10 - US-001
- Created migration for `api_secrets` table (UUID PK, name, secret_hash, subject_pattern, created_at)
- Created migration for `api_secret_subscribers` join table with CASCADE deletes
- Created sqlc queries: InsertApiSecret, GetApiSecretByID, ListApiSecrets (with subscriber name join), DeleteApiSecret, AddApiSecretSubscriber, RemoveApiSecretSubscriber, ListSubscribersForApiSecret, ListApiSecretsForSubscriber, UpdateApiSecret, RemoveAllApiSecretSubscribers, ListAllApiSecretHashes, GetApiSecretSubscriberExists
- Files changed: schema/20260206140000-create-api-secrets-table.sql, schema/20260206140001-create-api-secret-subscribers-table.sql, queries/api_secrets.sql, db/api_secrets.sql.go, db/models.go
- **Learnings for future iterations:**
  - string_agg with COALESCE generates `interface{}` type in sqlc unless you cast to `::text`
  - Added extra queries (UpdateApiSecret, RemoveAllApiSecretSubscribers, ListAllApiSecretHashes, GetApiSecretSubscriberExists) that will be needed by later stories
  - The join table queries use `ON CONFLICT DO NOTHING` for idempotent subscriber association
---

## 2026-02-06 14:15 - US-002
- Created app/secrets.go with all secret helper functions
- GenerateSecret: 32 bytes crypto/rand → URL-safe base64 (44 chars)
- HashSecret: bcrypt cost 10
- ValidateSecret: iterates all hashes, returns matching ListAllApiSecretHashesRow
- CheckSubscriberScope: delegates to GetApiSecretSubscriberExists query
- CheckSendScope/MatchLikePattern: recursive pattern matching implementing SQL LIKE (% and _)
- Files changed: app/secrets.go, go.mod, go.sum
- **Learnings for future iterations:**
  - golang.org/x/crypto was already in go.mod but needed upgrade for bcrypt; `go get` handled it
  - MatchLikePattern uses recursive approach for % wildcard matching
  - ValidateSecret returns db.ListAllApiSecretHashesRow (ID, SecretHash, SubjectPattern) not full ApiSecret
---

## 2026-02-06 14:20 - US-003
- Added X-Slurpee-Secret header validation to POST /api/events and GET /api/events/{id}
- POST /api/events: validates secret, then checks subject against subject_pattern via CheckSendScope (403 if mismatch)
- GET /api/events/{id}: validates any secret (read-only, no scope check)
- Subscriber endpoints unchanged (still use X-Slurpee-Admin-Secret)
- Failed auth attempts logged with slog.Warn including remote_addr
- Files changed: api/events.go
- **Learnings for future iterations:**
  - The api package uses a `log(ctx)` helper for context-aware logging, but direct `slog.Warn` is fine for auth logging since context logger is optional
  - API routes are registered via init() + registerRoute pattern, actual path prefix /api/ is added in AddApis via StripPrefix
  - POST validation checks secret first, then decodes body, then checks scope (so invalid secrets don't see body parse errors)
---

## 2026-02-06 14:25 - US-004
- Created app/sessions.go with SessionStore, SessionInfo, CreateSession, GetSession, DeleteSession
- SessionInfo holds SecretID, SubjectPattern, SubscriberIDs, IsAdmin, ExpiresAt
- Added Sessions *SessionStore field to Application struct, initialized in NewApp
- 32-byte crypto/rand token, hex encoded (64 chars)
- 24h TTL set in CreateSession, expired sessions cleaned on GetSession access
- Files changed: app/sessions.go, app/application.go
- **Learnings for future iterations:**
  - SessionStore is on Application struct as `Sessions`, accessible everywhere the app is
  - Token is hex-encoded (not base64) for cookie-safe characters
---

## 2026-02-06 14:30 - US-005
- Created views/login.templ: standalone login page (no SimplePage wrapper) with DaisyUI card, password input, error banner
- Created views/login.go: GET /login, POST /login, POST /logout handlers
- POST /login checks admin secret first (env var), then validates against stored API secrets via ValidateSecret
- On admin match: creates IsAdmin session with empty scope
- On API secret match: creates session with subscriber IDs from join table
- Failed logins logged with slog.Warn including remote_addr
- Cookie: slurpee_session (HttpOnly, SameSite=Lax, Path=/, no Secure)
- POST /logout: deletes session, clears cookie (MaxAge=-1), redirects to /login
- Files changed: views/login.templ, views/login_templ.go, views/login.go
- **Learnings for future iterations:**
  - templ generate auto-detects new .templ files and generates *_templ.go (runs via `templ generate`)
  - Login page is standalone HTML (no sidebar/header) — different from SimplePage wrapper used by other pages
  - Use pgtype.UUID directly in views package (import from pgx/v5/pgtype), not a type alias
---

## 2026-02-06 14:35 - US-006
- Created middleware/session-auth.go with SessionAuthMiddleware and GetSessionFromContext
- Exempt routes: /login, /static/*, /version, /api/* (API has its own auth)
- Unauthenticated requests get 302 redirect to /login
- Valid sessions injected into context via sessionContextKey{}
- Integrated in main.go: `SessionAuthMiddleware(slurpee)(router)` wrapped by AllStandardMiddleware
- Added logout button to sidebar (components/sidebar.templ) at bottom with mt-auto
- Files changed: middleware/session-auth.go, main.go, components/sidebar.templ, components/sidebar_templ.go
- **Learnings for future iterations:**
  - Session middleware needs app.Application for SessionStore access, so it takes Application as param and returns middleware func
  - API routes (/api/*) are exempt from session auth — they use their own header-based auth
  - GetSessionFromContext is in middleware package, usable by views package
  - templ generate says "File not updated" even when content changed if the hash matches — the update still works
---

## 2026-02-06 14:45 - US-007
- Created secrets list page at GET /secrets with admin-only access (403 for non-admin)
- Table displays name, subject_pattern, subscriber names, created_at with Edit/Delete buttons
- Delete uses DaisyUI modal confirmation, POST /secrets/{id}/delete handler
- Added admin-only "API Secrets" nav link to sidebar using context-based isAdminSession check
- Sidebar reads session from context via middleware.GetSessionFromContext (no parameter change needed)
- requireAdmin helper function reusable for future admin-only handlers
- Files changed: views/secrets.templ, views/secrets_templ.go, views/secrets.go, components/sidebar.templ, components/sidebar_templ.go
- **Learnings for future iterations:**
  - Sidebar uses context to detect admin status — no need to change its function signature
  - isAdminSession helper in sidebar.templ calls middleware.GetSessionFromContext(ctx)
  - Delete uses POST with /delete path suffix (not HTTP DELETE) for form compatibility
  - DaisyUI modal pattern: dialog element with showModal() script
---

## 2026-02-06 14:55 - US-008
- Added create secret form below the secrets table on /secrets page
- Form fields: name, subject_pattern, subscriber multi-select checkboxes
- Host:port constraint validation for subscriber selection
- POST /secrets generates secret, hashes, inserts, creates subscriber associations
- Plaintext secret shown once in alert-success banner with copy-to-clipboard button
- Empty subscriber selection allowed (send-only key)
- renderSecretsPage helper consolidates list + form rendering
- loadSubscriberOptions helper loads subscriber checkboxes
- extractHostPort parses endpoint_url for host:port validation
- Files changed: views/secrets.templ, views/secrets_templ.go, views/secrets.go
- **Learnings for future iterations:**
  - SecretsListTemplate now takes 5 params (secrets, subscribers, successMsg, errorMsg, plaintextSecret)
  - r.Form["subscriber_ids"] gets all checkbox values (vs r.FormValue which gets first)
  - navigator.clipboard.writeText used for copy-to-clipboard
  - Host:port constraint only checked when >1 subscriber selected
---

## 2026-02-06 15:05 - US-009
- Created secret edit page at GET /secrets/{id}/edit with pre-populated form
- POST /secrets/{id}/edit updates name, subject_pattern, and replaces subscriber associations
- Same host:port constraint validation as create form
- Pre-checks existing subscriber associations and marks checkboxes
- Uses delete-all + re-add pattern for subscriber association replacement
- On success, redirects back to /secrets list
- On validation error, re-renders edit form with error message
- Files changed: views/secret_edit.templ, views/secret_edit_templ.go, views/secrets.go
- **Learnings for future iterations:**
  - HTML forms don't support PUT, so using POST /secrets/{id}/edit instead
  - renderSecretEditPage helper loads all subscribers and marks associated ones
  - Replace pattern: RemoveAllApiSecretSubscribers + AddApiSecretSubscriber loop
---

## 2026-02-06 15:15 - US-010
- Added server-side scope enforcement to all subscriber write handlers (update, subscription create/delete) with checkSubscriberAccess returning 403
- Added server-side scope enforcement to event replay handlers (all + per-subscriber) with checkEventSubjectAccess returning 403
- Added subject scope check to eventCreateSubmitHandler (form validation error, not 403)
- Created views/scope_helpers.go with isSubscriberEditable, isSubjectInScope, isSessionAdmin for templ template use
- Updated subscriber_detail.templ: edit form, Add Subscription button, and subscription Delete buttons wrapped in isSubscriberEditable conditional; read-only fallback for non-editable
- Updated event_detail.templ: Replay All button and per-subscriber Replay buttons wrapped in isSubjectInScope conditional
- Files changed: views/scope_helpers.go (new), views/subscribers.go, views/events.go, views/subscriber_detail.templ, views/subscriber_detail_templ.go, views/event_detail.templ, views/event_detail_templ.go
- **Learnings for future iterations:**
  - templ templates use `ctx` implicitly — scope helper functions can use it to access session from context
  - Edit tool with tab-indented files: use tabs in old_string/new_string matching exactly as the file stores them
  - Subscriber list page has no edit controls (just click rows), so no scope changes needed there
  - checkSubscriberAccess compares pgtype.UUID directly (sid == subscriberID), while isSubscriberEditable in templates compares string representations
---
